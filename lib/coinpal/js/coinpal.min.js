/*
   Le Brand REAL IT Solutions - https://xdata.gr
   CoinPal Advanced PHP SDK 
   File coinpal.minn.js
   Version #1.01
*/
document.addEventListener("DOMContentLoaded", function() {
    var currentUrl = window.location.href;
    var tempAnchor = document.createElement('a');
    tempAnchor.href = currentUrl;
    var protocol = tempAnchor.protocol;
    var domain = tempAnchor.hostname;
    var fullUrl = protocol + "//" + domain;

    var version = Math.random().toString(36).substring(7);
    
    var head = document.head || document.getElementsByTagName('head')[0];

    var cssLinks = [
        fullUrl + "/lib/coinpal/css/all.min.css?v=" + version,
        fullUrl + "/lib/coinpal/css/main.css?v=" + version,
        fullUrl + "/lib/coinpal/css/bootstrap.min.css?v=" + version
    ];

    cssLinks.forEach(function(cssLink) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = cssLink;
        head.appendChild(link);
    });

    var jqueryScript = document.createElement('script');
    jqueryScript.src = fullUrl + "/lib/coinpal/js/jquery-3.6.0.min.js?v=" + version;
    head.appendChild(jqueryScript);

    var coinpalsettingsDiv = document.createElement("div");
    coinpalsettingsDiv.id = "coinpalsettings";
    document.querySelector(".signup-container").appendChild(coinpalsettingsDiv);

    var xhr = new XMLHttpRequest();
    var ajaxedHTML;
    var url = '/lib/coinpal/create_form_from_config.php';

    xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status == 200) {
                ajaxedHTML = xhr.responseText;
                createForm(ajaxedHTML); // Call createForm function after obtaining HTML content
            } else {
                console.error("Error fetching HTML content: " + xhr.status);
            }
        }
    };
    xhr.open('GET', url, true);
    xhr.send();

    function createForm(formContent) {
        var formHtml = '<h2 class="signup-title">Coinpal Advanced PHP SDK Settings</h2><form class="signup-form" id="coinpalsetup" action="lib/coinpal/coinpalsetup.php" method="post">' + formContent +
            '<button type="submit" class="btn btn-primary signup-btn">Submit</button>' +
            '</form><div class="signup-links" style="padding-top:10px">Do you need help? <a href="#">Read me</a></div><div id="cpsres" class="signup-links" style="padding-top:10px;font-weight:bold;color:red">&nbsp;</div><div class="lebrand-credits"><a href="https://xdata.gr" title="Visit Le Brand REAL IT Solutions" target="_blank">Le Brand REAL IT Solutions</a></div>';

        document.getElementById("coinpalsettings").innerHTML = formHtml;

        // Add event listener for form submission after the form is created
        document.getElementById("coinpalsetup").addEventListener("submit", function(event) {
            event.preventDefault();

            var formData = new FormData(this);
            var xhr = new XMLHttpRequest();

            xhr.open("POST", fullUrl + "/lib/coinpal/coinpalsetup.php", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onload = function() {
                if (xhr.status == 200) {
                    var response = JSON.parse(xhr.responseText);
                    var respText = response.text;
                    var respStatus = response.status;
                    document.getElementById("cpsres").innerText = respText;
                    setTimeout(function() {
                        document.getElementById("cpsres").innerHTML = "&nbsp;";
                    }, 2000);
                }
            };
            xhr.send(new URLSearchParams(formData));
        });
    }
});