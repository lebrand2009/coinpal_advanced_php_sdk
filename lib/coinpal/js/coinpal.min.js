/*
   Le Brand REAL IT Solutions - https://xdata.gr
   CoinPal Advanced PHP SDK 
   File coinpal.min.js
   Version #1.01
*/
document.addEventListener("DOMContentLoaded", function() {

function setCookie(name, value, days) { document.cookie = name + "=" + (value || "") + (days ? "; expires=" + new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString() : "") + "; path=/"; }
function getCookie(name) { return document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + name + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1") || null; }	

setCookie('jquery', '0', 1);
	
    function waitForJQuery(callback) {
      var jqueryLoaded = getCookie('jquery');
      if (jqueryLoaded === '1') {
        callback();
      } else {
        setTimeout(function() { 
          waitForJQuery(callback);
        }, 100);}
    }	
	
    function checkFieldsFilled() {
        var dbHost = document.getElementById("db_host").value;
        var dbName = document.getElementById("db_name").value;
        var dbUser = document.getElementById("db_user").value;
        var dbPass = document.getElementById("db_pass").value;

        return dbHost !== "" && dbName !== "" && dbUser !== "" && dbPass !== "";
    }

    function toggleButtonState() {
        var button = document.getElementById("checkconn");
        button.disabled = !checkFieldsFilled();
    }
			
    var currentUrl = window.location.href;
    var tempAnchor = document.createElement('a');
    tempAnchor.href = currentUrl;
    var protocol = tempAnchor.protocol;
    var domain = tempAnchor.hostname;
    var fullUrl = protocol + "//" + domain;

    var version = Math.random().toString(36).substring(7);
    
    var head = document.head || document.getElementsByTagName('head')[0];

    var cssLinks = [
        fullUrl + "/lib/coinpal/css/all.min.css",
        fullUrl + "/lib/coinpal/css/main.css?v=" + version,
        fullUrl + "/lib/coinpal/css/bootstrap.min.css"
    ];

    cssLinks.forEach(function(cssLink) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = cssLink;
        head.appendChild(link);
    });

    var jqueryScript = document.createElement('script');
    jqueryScript.src = fullUrl + "/lib/coinpal/js/jquery-3.6.0.min.js";
    head.appendChild(jqueryScript);
    jqueryScript.onload = function() { setCookie('jquery', '1', 1); };
	
    var elementsScript = document.createElement('script');
    elementsScript.src = fullUrl + "/lib/coinpal/js/elements.js";
    head.appendChild(elementsScript);
	
	/* ELEMENTS INJECTION BEGIN */
	elementsScript.onload = function() {
	const mainContainer = document.getElementById("mainContainer");
	const navElement = document.createElement("span");
	navElement.innerHTML = navigationElement;
	mainContainer.parentNode.insertBefore(navElement, mainContainer);	
		

	}
	/* ELEMENTS INJECTION END */
	
    var coinpalsettingsDiv = document.createElement("div");
    coinpalsettingsDiv.id = "coinpalsettings";
    document.querySelector(".lebrand-container").appendChild(coinpalsettingsDiv);

    var xhr = new XMLHttpRequest();
    var ajaxedHTML;
    var url = '/lib/coinpal/create_form_from_config.php';

    xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status == 200) {
                ajaxedHTML = xhr.responseText;
                createForm(ajaxedHTML); // TODO : Pass the 2 parts of formHtml in createForm
            } else {
                console.error("Error fetching HTML content: " + xhr.status);
            }
        }
    };
    xhr.open('GET', url, true);
    xhr.send();

    function createForm(formContent) {
		
       //TODO : Move formHtml to elements.js in 2 parts : Before and after formContent
		
        var formHtml = '<h2 class="signup-title" style="color:#7DCDBA;"><img src="/lib/coinpal/img/coinpal.png" title="CoinPal Payments Advanced PHP SDK" width="150"><br><hr>Advanced PHP SDK Settings<br><span style="font-size:65%"><a href="https://xdata.gr" title="Visit Le Brand REAL IT Solutions" target="_blank">Le Brand REAL IT Solutions</a></span></h2><hr><form class="signup-form" id="coinpalsetup" action="lib/coinpal/coinpalsetup.php" method="post">' + formContent +
            '<button type="button" id="checkconn" class="btn btn-warning signup-btn" style="font-weight:bold">Test DB Connectivity</button><br><br><button type="submit" class="btn btn-primary signup-btn" style="background-color:#7DCDBA;border: 2px solid #353A40;color: #353A40;font-size:160%;font-weight:bold">Submit</button>' +
            '</form><div class="signup-links" style="padding-top:10px">Do you need help? <a target="_blank" title="Visit GitHub official project page" href="https://github.com/lebrand2009/coinpal_advanced_php_sdk">Read me</a></div><hr><div class="lebrand-credits"><a href="https://xdata.gr" title="Visit Le Brand REAL IT Solutions" target="_blank">Le Brand REAL IT Solutions</a></div>';

        document.getElementById("coinpalsettings").innerHTML = formHtml;
		
        var body = document.body || document.getElementsByTagName('body')[0];	
	    var bootstrapScript = document.createElement('script');
        bootstrapScript.src = fullUrl + "/lib/coinpal/js/bootstrap.bundle.min.js";
        body.appendChild(bootstrapScript);		
		
    document.getElementById("db_host").addEventListener("input", toggleButtonState);
    document.getElementById("db_name").addEventListener("input", toggleButtonState);
    document.getElementById("db_user").addEventListener("input", toggleButtonState);
    document.getElementById("db_pass").addEventListener("input", toggleButtonState);
						  
    function informTheUser(modalTitle, modalText) {
		// console.log('Modal on'); // debug
		var modalID = Math.random().toString(36).substring(7);
		var outerDivID = Math.random().toString(36).substring(7);
        const modalDiv = document.createElement('div');
		modalDiv.id = outerDivID;
        modalDiv.innerHTML = `<div class="modal fade" id="${modalID}" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><img src="/lib/coinpal/img/coinpal.png" title="CoinPal Payments Advanced PHP SDK" width="150"><span class="mx-auto"><h5 class="modal-title" id="staticBackdropLabel" style="color:#7DCDBA;font-weight:bold">${modalTitle}</h5></span><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><p style="font-weight:bold">${modalText}</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal" style="font-weight:bold;background-color: #7DCDBA;border: 2px solid #353A40;border-radius: 4px;color: #353A40;">Close</button></div></div></div></div>`;
        document.body.appendChild(modalDiv);
        $('#' + modalID).modal('show');		
        $('#' + modalID).on('hidden.bs.modal', function (e) {
		$('#' + outerDivID).remove();	
            //$('#' + modalID).remove(); // no need to remove this because we remove the outerDivID div
            //console.log('Modal off'); // debug
        });		
    }
			
    document.getElementById("checkconn").addEventListener("click", function() {
        if (checkFieldsFilled()) {
            var dbHost = document.getElementById("db_host").value;
            var dbName = document.getElementById("db_name").value;
            var dbUser = document.getElementById("db_user").value;
            var dbPass = document.getElementById("db_pass").value;

            var url = "/lib/coinpal/test_db_connectivity.php";
            var params = "host=" + encodeURIComponent(dbHost) + "&name=" + encodeURIComponent(dbName) +
                         "&user=" + encodeURIComponent(dbUser) + "&pass=" + encodeURIComponent(dbPass);

            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var result = xhr.responseText;
					informTheUser('DB Settings', result);
                }
            };
            xhr.send(params);
        } else {
            //alert("Please fill all database fields");
			informTheUser('DB Settings', 'Please fill all database fields');
        }
    });		
				
        document.getElementById("coinpalsetup").addEventListener("submit", function(event) {
            event.preventDefault();

            var formData = new FormData(this);
            var xhr = new XMLHttpRequest();

            xhr.open("POST", fullUrl + "/lib/coinpal/coinpalsetup.php", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onload = function() {
                if (xhr.status == 200) {
                    var response = JSON.parse(xhr.responseText);
                    var respText = response.text;
                    var respStatus = response.status;
					informTheUser('Settings', respText);
                }
            };
            xhr.send(new URLSearchParams(formData));
        });
		
		const scrollToTopBtnDiv = document.createElement('div');
		      scrollToTopBtnDiv.id = 'scrollToTopBtnDiv';
              scrollToTopBtnDiv.innerHTML = '<button id="scrollToTopBtn" class="btn btn-primary" style="display: none;"><i class="fas fa-arrow-up"></i></button>';
		document.body.appendChild(scrollToTopBtnDiv);
		
		const scrollToBottomBtnDiv = document.createElement('div');
		scrollToBottomBtnDiv.id = 'scrollToBottomBtnDiv';
		scrollToBottomBtnDiv.innerHTML = '<button id="scrollToBottomBtn" class="btn btn-primary" style="display: none;"><i class="fas fa-arrow-down"></i></button>';
		document.body.appendChild(scrollToBottomBtnDiv);		
		
    }		
	
waitForJQuery(function() {
    $(window).scroll(function() {
        if ($(this).scrollTop() > 100) {
            $('#scrollToTopBtn, #scrollToBottomBtn').fadeIn();
        } else {
            $('#scrollToTopBtn, #scrollToBottomBtn').fadeOut();
        }
    });

    $('#scrollToTopBtn').click(function() {
        $('html, body').animate({scrollTop: 0}, 800);
        return false;
    });

    $('#scrollToBottomBtn').click(function() {
        $('html, body').animate({scrollTop: $(document).height()}, 800);
        return false;
    });
});	
	
	
});


