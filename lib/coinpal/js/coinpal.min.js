/*
   Le Brand REAL IT Solutions - https://xdata.gr
   CoinPal Advanced PHP SDK 
   File coinpal.minn.js
   Version #1.01
*/
document.addEventListener("DOMContentLoaded", function() {
		
    function checkFieldsFilled() {
        var dbHost = document.getElementById("db_host").value;
        var dbName = document.getElementById("db_name").value;
        var dbUser = document.getElementById("db_user").value;
        var dbPass = document.getElementById("db_pass").value;

        return dbHost !== "" && dbName !== "" && dbUser !== "" && dbPass !== "";
    }

    function toggleButtonState() {
        var button = document.getElementById("checkconn");
        button.disabled = !checkFieldsFilled();
    }	
		
    var currentUrl = window.location.href;
    var tempAnchor = document.createElement('a');
    tempAnchor.href = currentUrl;
    var protocol = tempAnchor.protocol;
    var domain = tempAnchor.hostname;
    var fullUrl = protocol + "//" + domain;

    var version = Math.random().toString(36).substring(7);
    
    var head = document.head || document.getElementsByTagName('head')[0];

    var cssLinks = [
        fullUrl + "/lib/coinpal/css/all.min.css",
        fullUrl + "/lib/coinpal/css/main.css?v=" + version,
        fullUrl + "/lib/coinpal/css/bootstrap.min.css"
    ];

    cssLinks.forEach(function(cssLink) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = cssLink;
        head.appendChild(link);
    });

    var jqueryScript = document.createElement('script');
    jqueryScript.src = fullUrl + "/lib/coinpal/js/jquery-3.6.0.min.js";
    head.appendChild(jqueryScript);
		
    var coinpalsettingsDiv = document.createElement("div");
    coinpalsettingsDiv.id = "coinpalsettings";
    document.querySelector(".signup-container").appendChild(coinpalsettingsDiv);

    var xhr = new XMLHttpRequest();
    var ajaxedHTML;
    var url = '/lib/coinpal/create_form_from_config.php';

    xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status == 200) {
                ajaxedHTML = xhr.responseText;
                createForm(ajaxedHTML);
            } else {
                console.error("Error fetching HTML content: " + xhr.status);
            }
        }
    };
    xhr.open('GET', url, true);
    xhr.send();

    function createForm(formContent) {
        var formHtml = '<h2 class="signup-title">Coinpal Advanced PHP SDK Settings</h2><form class="signup-form" id="coinpalsetup" action="lib/coinpal/coinpalsetup.php" method="post">' + formContent +
            '<button type="button" id="checkconn" class="btn btn-warning signup-btn">Test DB Connectivity</button><br><br><button type="submit" class="btn btn-primary signup-btn">Submit</button>' +
            '</form><div class="signup-links" style="padding-top:10px">Do you need help? <a target="_blank" title="Visit GitHub official project page" href="https://github.com/lebrand2009/coinpal_advanced_php_sdk">Read me</a></div><div id="cpsres" class="signup-links" style="padding-top:10px;font-weight:bold;color:red">&nbsp;</div><div class="lebrand-credits"><a href="https://xdata.gr" title="Visit Le Brand REAL IT Solutions" target="_blank">Le Brand REAL IT Solutions</a></div>';

        document.getElementById("coinpalsettings").innerHTML = formHtml;
		
        var body = document.body || document.getElementsByTagName('body')[0];	
	    var bootstrapScript = document.createElement('script');
        bootstrapScript.src = fullUrl + "/lib/coinpal/js/bootstrap.bundle.min.js";
        body.appendChild(bootstrapScript);		
		
    document.getElementById("db_host").addEventListener("input", toggleButtonState);
    document.getElementById("db_name").addEventListener("input", toggleButtonState);
    document.getElementById("db_user").addEventListener("input", toggleButtonState);
    document.getElementById("db_pass").addEventListener("input", toggleButtonState);

    document.getElementById("checkconn").addEventListener("click", function() {
        if (checkFieldsFilled()) {
            var dbHost = document.getElementById("db_host").value;
            var dbName = document.getElementById("db_name").value;
            var dbUser = document.getElementById("db_user").value;
            var dbPass = document.getElementById("db_pass").value;

            var url = "/lib/coinpal/test_db_connectivity.php";
            var params = "host=" + encodeURIComponent(dbHost) + "&name=" + encodeURIComponent(dbName) +
                         "&user=" + encodeURIComponent(dbUser) + "&pass=" + encodeURIComponent(dbPass);

            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var result = xhr.responseText;
					document.getElementById("cpsres").innerText = result;
					setTimeout(function() {
                        document.getElementById("cpsres").innerHTML = "&nbsp;";
                    }, 2000);
                    //alert(result);
                }
            };
            xhr.send(params);
        } else {
            alert("Please fill all database fields");
        }
    });		
				
        document.getElementById("coinpalsetup").addEventListener("submit", function(event) {
            event.preventDefault();

            var formData = new FormData(this);
            var xhr = new XMLHttpRequest();

            xhr.open("POST", fullUrl + "/lib/coinpal/coinpalsetup.php", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onload = function() {
                if (xhr.status == 200) {
                    var response = JSON.parse(xhr.responseText);
                    var respText = response.text;
                    var respStatus = response.status;
                    document.getElementById("cpsres").innerText = respText;
                    setTimeout(function() {
                        document.getElementById("cpsres").innerHTML = "&nbsp;";
                    }, 2000);
                }
            };
            xhr.send(new URLSearchParams(formData));
        });
    }
});